FROM node:14.4.0-alpine

ARG REACT_APP_VERSION
ARG GCP_PROJECT_ID
ARG REACT_APP_PROJECT_NAME
ARG MONGO_DB_URL
ARG MONGO_DB_USER
ARG MONGO_DB_PASS
ARG MONGO_DB_DB_NAME
ARG CRON_PASSWORD
ARG GCP_SERVICE_ACCOUNT_EMAIL
ARG GCP_SERVICE_ACCOUNT_PRIVATE_KEY
ARG GCP_ASSET_BUCKET
ARG ADMIN_INIT_USER
ARG ADMIN_INIT_PASSWORD
ARG REACT_APP_DOCS_URL
ARG REACT_APP_BACKEND_URL
ARG REACT_APP_ADMIN_URL
ARG IOS_APP_SECRET
ARG GCP_VIDEO_SOURCES_BUCKET

ENV REACT_APP_VERSION=$REACT_APP_VERSION
ENV GCP_PROJECT_ID=$GCP_PROJECT_ID
ENV REACT_APP_PROJECT_NAME=$REACT_APP_PROJECT_NAME
ENV MONGO_DB_URL=$MONGO_DB_URL
ENV MONGO_DB_USER=$MONGO_DB_USER
ENV MONGO_DB_PASS=$MONGO_DB_PASS
ENV MONGO_DB_DB_NAME=$MONGO_DB_DB_NAME
ENV CRON_PASSWORD=$CRON_PASSWORD
ENV GCP_SERVICE_ACCOUNT_EMAIL=$GCP_SERVICE_ACCOUNT_EMAIL
ENV GCP_SERVICE_ACCOUNT_PRIVATE_KEY=$GCP_SERVICE_ACCOUNT_PRIVATE_KEY
ENV GCP_ASSET_BUCKET=$GCP_ASSET_BUCKET
ENV ADMIN_INIT_USER=$ADMIN_INIT_USER
ENV ADMIN_INIT_PASSWORD=$ADMIN_INIT_PASSWORD
ENV REACT_APP_DOCS_URL=$REACT_APP_DOCS_URL
ENV REACT_APP_BACKEND_URL=$REACT_APP_BACKEND_URL
ENV REACT_APP_ADMIN_URL=$REACT_APP_ADMIN_URL
ENV IOS_APP_SECRET=$IOS_APP_SECRET
ENV GCP_VIDEO_SOURCES_BUCKET=$GCP_VIDEO_SOURCES_BUCKET

RUN apk add  --no-cache ffmpeg

WORKDIR /usr/src/backend
COPY ./backend/package*.json ./
RUN npm install
COPY ./backend ./
RUN npm run build

EXPOSE 8080

CMD ["npm", "run", "start"]